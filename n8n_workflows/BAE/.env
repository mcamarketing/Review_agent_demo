# ═══════════════════════════════════════════════════════════════════════════
# BUSINESS ARCHITECTURE ENGINE — n8n Environment Configuration
# Self-hosted Docker. Apply via docker-compose.yml `env_file: .env`
# Version: 1.0 | Tested: n8n >= 1.28
# ═══════════════════════════════════════════════════════════════════════════

# ── Core Identity ────────────────────────────────────────────────────────────
N8N_HOST=0.0.0.0
N8N_PORT=5678
N8N_PROTOCOL=https
WEBHOOK_URL=https://YOUR_N8N_DOMAIN
# 32-character random string. Generate: openssl rand -hex 16
N8N_ENCRYPTION_KEY=REPLACE_WITH_32_CHAR_RANDOM_STRING

# ── PostgreSQL (n8n internal DB — NOT the BAE app DB) ───────────────────────
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=postgres
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n_user
DB_POSTGRESDB_PASSWORD=REPLACE_WITH_STRONG_PASSWORD
DB_POSTGRESDB_SCHEMA=public
DB_POSTGRESDB_SSL_ENABLED=true
DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED=false

# ── BAE Application Database (used in Postgres nodes inside workflows) ───────
# These are NOT used by n8n itself — they are for reference.
# Set these as the values in your "postgresMain" n8n Credential.
# BAE_DB_HOST=postgres
# BAE_DB_PORT=5432
# BAE_DB_NAME=bae
# BAE_DB_USER=bae_user
# BAE_DB_PASSWORD=REPLACE_WITH_STRONG_PASSWORD

# ── Execution Timeouts ───────────────────────────────────────────────────────
# UNIT: SECONDS.
# Soft workflow timeout — workflow can run up to 1 hour before n8n sends a
# gentle termination signal. The current node finishes before termination.
EXECUTIONS_TIMEOUT=3600

# UNIT: SECONDS.
# Absolute hard ceiling. Users cannot set a per-workflow timeout above this.
# Set to 2 hours to support SW-04 recursive deep build loops.
EXECUTIONS_TIMEOUT_MAX=7200

# UNIT: MILLISECONDS — CRITICAL: this variable is in ms, NOT seconds.
# Overrides the native Node.js fetch library's Headers Timeout.
# Without this, DeepSeek-R1 reasoning traces that exceed ~5 minutes will throw
# an ERR_HEADERS_TIMEOUT and kill the HTTP Request node mid-stream.
# 3600000ms = 1 hour. This is the single most important timeout variable.
N8N_AI_TIMEOUT_MAX=3600000

# ── Execution Data Pruning — Lean Memory ────────────────────────────────────
# NEVER save intermediate node state to DB during execution.
# This is the #1 cause of RAM exhaustion when passing multi-KB LLM JSON
# payloads between nodes. Disable it unconditionally.
EXECUTIONS_DATA_SAVE_ON_PROGRESS=false

# Do not write success execution data to DB at all. BAE state lives in Postgres.
# Failures are retained for debugging.
EXECUTIONS_DATA_SAVE_ON_SUCCESS=none
EXECUTIONS_DATA_SAVE_ON_ERROR=all

# Enable background pruning daemon for old execution records.
EXECUTIONS_DATA_PRUNE=true

# Soft-delete execution records older than 7 days. Adjust for compliance needs.
EXECUTIONS_DATA_MAX_AGE=168

# ── Queue Mode — Required for True Parallel Fan-Out ─────────────────────────
# Queue mode offloads execution to worker processes via Bull/Redis.
# This is mandatory for the parallel fan-out (3x LLM calls simultaneously)
# to actually execute in parallel rather than sequentially.
EXECUTIONS_MODE=queue

# ── Redis (Bull Queue Backend) ───────────────────────────────────────────────
QUEUE_BULL_REDIS_HOST=redis
QUEUE_BULL_REDIS_PORT=6379
QUEUE_BULL_REDIS_PASSWORD=REPLACE_WITH_REDIS_PASSWORD
QUEUE_BULL_REDIS_TLS=false
# Max concurrent jobs per worker process. Match to your vCPU count.
QUEUE_WORKER_CONCURRENCY=10

# ── Concurrency & Performance ────────────────────────────────────────────────
# Max simultaneous executions across all workers.
N8N_CONCURRENCY_PRODUCTION_LIMIT=25

# ── Security ─────────────────────────────────────────────────────────────────
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=REPLACE_WITH_STRONG_PASSWORD

# Restrict which webhook paths are accessible without auth.
# Leave empty to allow all (webhook paths are authenticated by n8n internally).
# N8N_WEBHOOK_ALLOWED_URIS=

# ── Logging ──────────────────────────────────────────────────────────────────
# Use 'warn' in production. Use 'debug' only when actively debugging node failures.
N8N_LOG_LEVEL=warn
N8N_LOG_OUTPUT=console

# ── Node Options — V8 Heap Size ──────────────────────────────────────────────
# Increase V8 heap to 4GB to handle massive LLM JSON payloads in Code nodes.
# Without this, JSON.stringify on a large contender array will OOM crash n8n.
NODE_OPTIONS=--max-old-space-size=4096

# ── Timezone ─────────────────────────────────────────────────────────────────
GENERIC_TIMEZONE=UTC

# ── Diagnostics / Telemetry ──────────────────────────────────────────────────
# Disable external telemetry for ZDR compliance with client data.
N8N_DIAGNOSTICS_ENABLED=false
N8N_VERSION_NOTIFICATIONS_ENABLED=false

# ── Reverse Proxy Note ───────────────────────────────────────────────────────
# If you sit behind nginx, you MUST also set these in your nginx config:
#   proxy_read_timeout 3600;
#   proxy_connect_timeout 3600;
#   proxy_send_timeout 3600;
#   keepalive_timeout 3600;
# Failure to do so means nginx will terminate the connection during long
# DeepSeek-R1 reasoning traces before n8n even sees the response.
